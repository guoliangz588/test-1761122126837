# 智能健康问询系统 - MCP Supabase 集成实现文档

## 🎯 **项目概述**
智能健康问询系统是一个基于双Agent架构的健康调查问卷系统，通过MCP Supabase集成实现完整的数据持久化和会话管理功能。

**系统ID**: `system_1757299256379_mu0enk1lw`
**版本**: v5.0.0
**状态**: 核心功能已实现，存在权限配置问题待修复

---

## 📊 **当前实现架构**

### **双Agent架构设计**
```
智能健康问询系统 (system_1757299256379_mu0enk1lw)
├── survey-assistant (健康问卷调查助手)
│   ├── 类型: orchestrator  
│   ├── 功能: 12问健康调查对话管理
│   ├── 职责: 数据验证、JSON生成、Agent协调
│   └── ❌ 权限问题: toolAccess = []
└── supabase-agent (数据库存储代理)
    ├── 类型: tool
    ├── 功能: MCP数据库操作
    ├── 职责: 会话管理、消息持久化、进度快照
    └── ❌ 权限问题: toolAccess = []
```

### **核心连接关系**
```json
"connections": [
  {
    "from": "survey-assistant",
    "to": "supabase-agent", 
    "type": "tool_call",
    "condition": "需要数据库操作时"
  },
  {
    "from": "survey-assistant",
    "to": "END",
    "type": "completion", 
    "condition": "问卷完成时"
  }
]
```

---

## 🗃️ **数据库设计详解**

### **表结构设计**

#### **1. chat_sessions (会话表)**
```typescript
interface ChatSession {
  id: string;                    // 主键：会话唯一ID (UUID)
  user_id: string;              // 外键：用户ID (UUID) 
  system_id: string;            // 系统标识符 (如: system_1757299256379_mu0enk1lw)
  title?: string;               // 会话标题 (如: "Health Survey Session")
  status: 'active' | 'paused' | 'completed' | 'archived';
  snapshot: Record<string, any>; // 🔥 核心：问卷进度JSON数据
  snapshot_updated_at?: string;  // 快照最后更新时间
  created_at: string;           // 会话创建时间
  updated_at: string;           // 会话更新时间
}
```

#### **2. chat_messages (消息表)**  
```typescript
interface ChatMessage {
  id: string;                   // 主键：消息唯一ID (UUID)
  session_id: string;          // 🔗 外键：关联到chat_sessions.id
  user_id: string;             // 外键：用户ID (与session.user_id一致)
  agent_id?: string;           // 消息发送方 (survey-assistant/supabase-agent)
  role: 'system' | 'user' | 'assistant' | 'tool';
  content?: string;            // 消息文本内容
  content_json?: Record<string, any>; // JSON格式内容（用于结构化数据）
  client_msg_id?: string;      // 客户端消息ID（去重用）
  seq?: number;                // 消息序号（自动递增）
  created_at: string;          // 消息创建时间
}
```

### **表关系图**
```
┌─────────────────┐         ┌─────────────────┐
│  chat_sessions  │ 1 ────N │  chat_messages  │
│                 │         │                 │  
│ • id (PK)       │◄────────┤ • session_id    │
│ • user_id       │         │ • id (PK)       │
│ • system_id     │         │ • user_id       │
│ • snapshot      │         │ • agent_id      │
│ • status        │         │ • role          │
│ • created_at    │         │ • content       │
└─────────────────┘         │ • created_at    │
                            └─────────────────┘
```

### **Mock数据策略**
为简化开发，系统采用确定性UUID生成：
```typescript
// 固定的Mock数据ID模式
user_id: generateDeterministicUUID(`${systemId}_mock_user`)
// 结果示例: "a1b2c3d4-e5f6-4789-8abc-def012345678"

session_id: generateDeterministicUUID(`${systemId}_mock_session`) 
// 结果示例: "f1e2d3c4-b5a6-4978-8cba-fed210987654"
```

### **Snapshot数据结构**
问卷进度快照的标准格式：
```json
{
  "progress": {
    "total_questions": 12,
    "answered": 3,
    "current_question": 4
  },
  "partial_answers": {
    "age": 25,
    "weight_pounds": 150,
    "height": "5'8\"",
    "sex_assigned_at_birth": "male"
  },
  "question_status": {
    "1": "completed",
    "2": "completed", 
    "3": "completed",
    "4": "pending",
    "5": "pending"
  }
}
```

---

## 📋 **12问健康调查流程**

### **问卷结构设计**
| 步骤 | 分组 | 问题数 | 预计时间 | 内容 |
|------|------|---------|----------|------|
| **STEP 1** | Basic Profile | 5问 | ~30s | 年龄、体重、身高、性别、种族 |
| **STEP 2** | Medical History | 3问 | ~3m | 疾病史、手术史、过敏史 |  
| **STEP 3** | Medications & Supplements | 2问 | ~5m | 处方药、保健品 |
| **STEP 4** | Miscellaneous | 2问 | ~30s | 替代医学、可穿戴设备 |

### **详细问题列表**

#### **STEP 1: Basic Profile (~30s)**
1. **年龄**: "How old are you?"
2. **体重**: "What is your weight in pounds? (If in kg, please say so.)"  
3. **身高**: "What is your height? (Feet/inches or cm are fine.)"
4. **性别**: "What was your sex assigned at birth?"
5. **种族**: "Which ancestries apply to you? (Choose from the list. If 'Other', please specify.)"

#### **STEP 2: Medical History (~3m)**  
6. **疾病史**: "Please select any conditions from this list. (If 'Other', specify. If 'None', choose only 'None'.)"
7. **手术史**: "Any surgeries or overnight hospital stays? (List as 'procedure (year)'. Say 'none' if none.)"
8. **过敏史**: "Do you have any allergies? (Choose from allergens list. For each, ask 'What reaction do you have?' If 'Other Allergens', please specify allergen name(s). If 'none', record none.)"

#### **STEP 3: Medications & Supplements (~5m)**
9. **处方药**: "Do you take any medications? (For each: Name, Dose/Strength, Frequency, Purpose. Say 'none' if none.)"
10. **保健品**: "Do you take any supplements? (For each: Name, Dose/Strength, Frequency, Purpose. Say 'none' if none.)"

#### **STEP 4: Miscellaneous (~30s)**
11. **替代医学**: "Which complementary & alternative medicine (CAM) fields do you prefer? (Options: Functional Medicine, Ayurveda, Traditional Chinese Medicine, Homeopathy, Hanyak, All. 'All' expands.)"
12. **可穿戴设备**: "Do you use any of these wearable devices? (OURA Ring, Apple Watch, Google Pixel Watch, Fitbit, None.)"

### **数据规范化规则**
- **身高处理**: 接受ft/in或cm，自动计算height_inches_total
- **体重转换**: 优先使用磅，kg自动转换
- **枚举验证**: 严格按照预定义枚举列表验证
- **数据清理**: 自动去重、去空格、标准化格式

---

## 🛠️ **技术实现详情**

### **MCP Supabase集成**

#### **环境变量配置**
```env
# Supabase配置 (已配置)
NEXT_PUBLIC_SUPABASE_URL=https://oqlhmmdachoiuzcbwexs.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# 代理配置 (已配置)
PROXY_ENABLED=true
PROXY_HOST=127.0.0.1
PROXY_PORT=7890
```

#### **MCP操作类型**
```typescript  
type MCPOperationType = 
  | 'create_session'     // 创建新会话
  | 'save_message'       // 保存消息
  | 'update_snapshot'    // 更新进度快照  
  | 'get_session'        // 查询会话（支持include_messages）
  | 'create_tables'      // 初始化数据库表
  | 'get_sessions'       // 获取用户会话列表
  | 'delete_session';    // 删除会话
```

### **Enhanced Runtime Engine集成**

#### **MCP工具调用逻辑**
```typescript
// 权限检查 (第85行)
const hasMCPTools = agentDef.toolAccess.includes('mcp-supabase-operations')

// Schema添加 (第87-91行)
if (hasMCPTools) {
  baseSchema.mcpOperations = z.array(z.object({
    type: z.enum(['create_session', 'save_message', 'update_snapshot', /*...*/]),
    data: z.any()
  })).optional()
}

// 执行处理 (第383-410行)
if (result.object.mcpOperations) {
  for (const mcpOp of result.object.mcpOperations) {
    const mcpResult = await mcpSupabaseProxy.executeOperation({
      type: mcpOp.type,
      data: mcpOp.data
    })
    executionResult.mcpToolCalls.push({ operation: mcpOp, result: mcpResult })
  }
}
```

### **前端集成实现**

#### **自动对话启动**
```typescript
// chat/page.tsx - 自动开始对话功能
const [autoStartTriggered, setAutoStartTriggered] = useState(false);

useEffect(() => {
  if (system && !autoStartTriggered && !isLoading && messages.length === 0) {
    setAutoStartTriggered(true);
    console.log('🚀 Auto-starting health survey conversation...');
    
    append({
      role: 'user',
      content: 'AUTO_START'  // 触发survey-assistant主动开始
    });
  }
}, [system, autoStartTriggered, isLoading, messages.length, append]);
```

#### **固定Session ID** 
```typescript  
// 支持会话恢复的固定ID
const [sessionId] = useState(`${systemId}_mock_session`);
```

---

## ❌ **当前存在的问题**

### **🔑 核心问题：Agent权限配置缺失**

#### **问题表现**
- 前端正常显示健康调查对话
- 后端正确处理问卷逻辑
- ❌ **Supabase数据库中无任何记录**
- ❌ **会话无法恢复，刷新页面丢失历史**

#### **根本原因**
两个核心Agent都缺少MCP工具访问权限：
```json
// 当前错误配置  
{
  "id": "survey-assistant",
  "toolAccess": []  // ❌ 空数组导致无法调用MCP操作
}
{
  "id": "supabase-agent", 
  "toolAccess": []  // ❌ 空数组导致无法执行数据库操作
}
```

#### **技术原理**
```typescript
// enhanced-runtime-engine.ts:85 权限检查逻辑
const hasMCPTools = agentDef.toolAccess.includes('mcp-supabase-operations')

// 结果: hasMCPTools = false
// 导致: 不添加mcpOperations到agent响应schema
// 结果: agent无法生成任何MCP数据库操作
```

### **🔧 解决方案**
```json
// 修复后的正确配置
{
  "id": "survey-assistant",
  "toolAccess": ["mcp-supabase-operations"]  // ✅ 添加MCP权限
}
{
  "id": "supabase-agent",
  "toolAccess": ["mcp-supabase-operations"]  // ✅ 添加MCP权限  
}
```

---

## ✅ **已完成功能清单**

### **后端实现 (100%完成)**
- [x] MCP Supabase代理完整实现 (`lib/mcp/mcp-proxy.ts`)
- [x] 数据库操作接口完整定义 (`lib/mcp/supabase-tool.ts`)  
- [x] Enhanced Runtime Engine MCP集成
- [x] 双Agent架构部署和连接配置
- [x] API Route增强流响应处理
- [x] Mock用户策略和确定性UUID生成

### **前端实现 (100%完成)**  
- [x] 聊天页面自动对话启动
- [x] 固定Session ID支持会话恢复
- [x] UI消息渲染和交互处理
- [x] 响应流解析和显示

### **配置管理 (95%完成)**
- [x] Supabase连接配置
- [x] 环境变量完整设置  
- [x] Agent系统提示词优化
- [x] 网络代理配置
- [ ] **Agent权限配置修复** (待完成)

---

## 🔄 **数据流程设计**

### **理想数据流**
```
用户输入 → survey-assistant → 问卷处理 → supabase-agent → MCP操作 → Supabase
    ↑                                                     ↓
继续问卷 ← 友好响应 ← 进度保存 ← 操作确认 ← 数据库写入 ← 表操作
```

### **当前实际流程**
```
用户输入 → survey-assistant → 问卷处理 → ❌权限检查失败 → 跳过MCP
    ↑                                          ↓
继续问卷 ← 友好响应 ← ⚠️无数据保存 ← 正常返回 ← 只有对话逻辑
```

---

## 📈 **性能和监控**

### **日志监控点**
```typescript
// 关键日志标识符
🔧 MCP Supabase operation: ${operation.type}     // MCP操作开始
✅ MCP operation result: ${JSON.stringify(...)}  // MCP操作完成  
❌ MCP operation failed: ${error}                // MCP操作失败
🎯 Running agent system for: ${userMessage}      // Agent系统启动
🚀 Auto-starting health survey conversation      // 自动对话启动
```

### **性能指标**
- **问卷完成率**: 目标 >90%
- **数据保存成功率**: 目标 100% (修复后)
- **会话恢复成功率**: 目标 100% (修复后)
- **对话响应时间**: 当前 2-8秒

---

## 🔮 **未来扩展计划**

### **短期目标 (1-2周)**
1. **修复权限配置问题** - 恢复数据持久化功能
2. **数据库表结构验证** - 确保Supabase表已创建
3. **端到端测试** - 验证完整问卷流程
4. **会话恢复测试** - 确保中断续传功能

### **中期目标 (1-2个月)**
1. **多用户支持** - 替换Mock用户为真实用户系统
2. **数据导出功能** - 支持JSON/CSV导出健康报告  
3. **高级分析** - 健康风险评估和建议生成
4. **移动端适配** - 响应式设计优化

### **长期目标 (3-6个月)**
1. **AI健康顾问** - 基于问卷数据的智能建议
2. **医疗集成** - 对接电子健康记录系统
3. **多语言支持** - 国际化健康问卷
4. **企业版功能** - 批量用户管理和报告

---

## 📚 **开发文档索引**

### **核心文件结构**
```
ui-tool-server-standalone/
├── data/agent-systems/
│   └── system_1757299256379_mu0enk1lw.json    # 系统配置
├── lib/
│   ├── mcp/
│   │   ├── mcp-proxy.ts                        # MCP代理实现  
│   │   └── supabase-tool.ts                    # 数据库接口定义
│   └── agents/
│       └── enhanced-runtime-engine.ts          # Agent运行时引擎
├── app/
│   ├── api/agent-chat/[systemId]/route.ts     # 聊天API路由
│   └── systems/[id]/chat/page.tsx             # 聊天页面组件
└── .env.local                                  # 环境变量配置
```

### **API端点**
- `POST /api/agent-chat/{systemId}` - 主聊天接口
- `POST /api/mcp-proxy` - MCP操作代理
- `GET /api/ui-register` - UI工具注册

### **关键配置**
- **系统ID**: `system_1757299256379_mu0enk1lw`
- **Mock Session ID**: `system_1757299256379_mu0enk1lw_mock_session`  
- **Supabase项目**: `oqlhmmdachoiuzcbwexs.supabase.co`

---

**最后更新**: 2025-09-08
**文档版本**: v2.0.0  
**系统状态**: 核心功能完整，权限配置待修复